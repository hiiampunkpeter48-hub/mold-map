<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mold Layout Map</title>

<!-- Firebase v8 CDNï¼ˆä¸ç”¨ Nodeï¼‰ -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
/* ===== æ‡¸æµ®æŒ‰éˆ• ===== */
#floatingBtn {
  position: fixed;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  z-index: 99999;          /* å…¨ç«™æœ€ä¸Šå±¤ */
  width: 55px;
  height: 55px;
  border-radius: 50%;
  background: #ff9800;
  color: white;
  font-size: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: grab;
  box-shadow: 0 4px 10px rgba(0,0,0,.4);
  user-select: none;
}

/* ===== æ‡¸æµ®é¸å–® ===== */
.floatingMenu {
  position: fixed;
  left: 70px;
  top: 50%;
  transform: translateY(-50%);
  z-index: 99999;
  background: white;
  border: 1px solid #999;
  padding: 10px;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0,0,0,.3);
}

.floatingMenu button {
  display: block;
  width: 160px;
  margin: 6px 0;
}

/* ğŸ“Œ ç®¡ç†å“¡æ§åˆ¶åˆ— (å›ºå®šåº•éƒ¨) */
.adminBar {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: rgba(255, 255, 255, 0.95);
  border-bottom: 1px solid #ccc;

  z-index: 60; /* é«˜æ–¼èƒŒæ™¯ã€ç©ºä½ã€å¤–æ¡†ï¼Œä½†ä½æ–¼äº’å‹•æç¤º */
  padding: 6px 10px;
}

/* ğŸ“Œ æœ‰æ²»å…·æ ¼å­é¡è‰² */
.cell.hasFruit {
  background-color: #9fdf9f; /* æ²»å…·æ ¼å­åº•è‰² */
}

/* ğŸ“Œ æœå°‹æŒ‰éˆ•æ¨£å¼ */
.searchBox button {
  padding: 6px 8px;
  cursor: pointer;
}

/* ğŸ“Œ æ–°å¢æ²»å…·å‹•ç•«æ•ˆæœ */
.cell.new-added {
  background-color: #7fd3ff;   /* æ·ºè—è‰²ï¼Œèˆ‡é¸å–é»ƒå€åˆ† */
  border-color: #1e90ff;
  box-shadow: 0 0 36px rgba(30,144,255,0.9);
}

/* ğŸ“Œ å„å€æ²»å…·æ¶æ¨™é¡Œé¡è‰² */
.boxes h3 {
  margin: 0 0 8px 0;
  padding: 6px 12px;
  font-size: 22px;
  border-radius: 6px;
}

.boxes.Aå€ h3 { background-color: #FF0000; } /* Aï¼šç´… */
.boxes.Bå€ h3 { background-color: #00B0F0; } /* Bï¼šè— */
.boxes.Cå€ h3 { background-color: #7030A0; } /* Cï¼šç´« */
.boxes.Då€ h3 { background-color: #92D050; } /* Dï¼šç¶  */
.boxes.Eå€ h3 { background-color: #FFC000; } /* Eï¼šæ©˜ */
.boxes.Få€ h3 { background-color: #FFFF00; } /* Fï¼šé»ƒ */
.boxes.Gå€ h3 { background-color: #00B050; } /* Gï¼šæ·±ç¶  */
.boxes.Hå€ h3 { background-color: #920000; } /* Hï¼šæ·±ç´… */
.boxes.Wå€ h3 { background-color: #ce93d8; } /* Wï¼šæ·ºç´« */
.boxes.Xå€ h3 { background-color: #90caf9; } /* Xï¼šæ·ºè— */
.boxes.Yå€ h3 { background-color: #ff6b6b; } /* Yï¼šæ·ºç´… */
.boxes.Zé ç•™å€ h3 { background-color: #ffa726; } /* Zï¼šæ·ºæ©˜ */

/* è¢å¹•å¤ªå°-ä¿éšª */
@media (max-width: 600px) {
  .topImageGroup img {
    height: 140px;
  }
}

/* æ”¾å¤§é®ç½© */
.imageOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.imageOverlay img {
  max-width: 90%;
  max-height: 90%;
  box-shadow: 0 0 20px #000;
  cursor: zoom-out;
}

/* ğŸ“Œ å³ä¸Šè§’åœ–ç‰‡ç¾¤çµ„ */
/* ç©©å®šä¸é‡ç–Š */
.topImageGroup {
  top: 2px;
  right: 20px;
  display: flex;
  gap: 2px;           /* åœ–ç‰‡é–“è· */
  z-index: 2000;
  flex-direction: column;  /* é å·¦ */
}

.topImageGroup img {
  height: 90px;
  cursor: pointer;    /* é»æ“Šæç¤º */
  transition: transform .2s;
}

.imageRow {
  display: flex;
  gap: 10px;
}

.imageRow img {
  height: 90px;
  cursor: pointer;
}

.imageHint {
  font-size: 16px;
  height: 6px;
  color: #333;
}

body {
  margin: 0;
}

.loginRow {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items: center;
margin-top: 16px;   /* å’Œä¸Šæ–¹å€å¡Šé–“è· */
}

/* ğŸ“Œ æœå°‹å€ */
.searchRow {
  position: relative;
  margin-top: 14px;   /* å’Œä¸Šæ–¹å€å¡Šé–“è· */
}

.searchBox {
  position: relative;
margin-top: 6px;   /* å’Œä¸Šæ–¹å€å¡Šé–“è· */
}

#search { width: 458px; }

.dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  width: 512px;
  background: #fff;
  border: 1px solid #666;
  z-index: 2000;
  max-height: 200px;
  overflow-y: auto;
}

.dropdown div {
  padding: 6px 10px;
  cursor: pointer;
}

.dropdown div:hover {
  background: #ffd966;
}

body {
  padding-bottom: 150px; /* è¦–ä½ çš„ adminBar é«˜åº¦èª¿æ•´ */
}

body { font-family: Arial, sans-serif; margin: 10px;background: #cccccc; }

/* ğŸ“Œ å½ˆæ€§ç›’å­Flexbox è£¡é¢çš„å…ƒç´ ï¼ˆh2ã€ç™»å…¥å€ã€æœå°‹å€ã€logï¼‰ */
input, button, select { padding: 8px; font-size: 16px; }
.room, .boxes { border: 8px solid #666666; padding: 10px; margin: 10px 0; }

/* ğŸ“Œ æ²»å…·æ ¼å­æ¨£å¼ */
.grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
.cell { border: 2px solid #666666; padding: 10px; text-align: center; cursor: pointer; user-select: none; }
.cell { background: white; }
.cell.empty { background: #f5f5f5; }
.cell.highlight {
  background-color: #9fdf9f;    /* æœå°‹å‘½ä¸­çµæœ */
  border-color: #FF0000;
  box-shadow: 0 0 36px rgba(255,144,144,0.9);
}

.cell.selected { background: #ffd966; border-color: #cc9900; }

/* ğŸ“Œ æ¬ç§»è¨˜éŒ„è¦–çª— */
.log { white-space: pre; background: #111; color: #0f0; padding: 10px; height: 400px; width: 630px; overflow: auto; font-size: 8px; }
.admin { background: #eef; padding: 10px; margin-top: 10px; }
.hidden { display:none; }

/* ===============================
   ğŸ“± æ‰‹æ©Ÿ / å¹³æ¿ éŸ¿æ‡‰å¼è¨­è¨ˆ
================================= */

/* è®“æ•´é«”å¯¬åº¦ä¸è¦è¶…å‡ºç•«é¢ */
* {
  box-sizing: border-box;
}

/* å­—é«”éš¨è¢å¹•ç¸®æ”¾ */
html {
  font-size: clamp(14px, 2.5vw, 18px);
}

/* æœå°‹æ¡†å¯¬åº¦æ”¹ç‚ºè‡ªé©æ‡‰ */
#search {
  width: 100%;
  max-width: 100%;
}

/* dropdown ä¸å›ºå®šå¯¬åº¦ */
.dropdown {
  width: 100%;
  max-width: 100%;
}

/* log è‡ªå‹•å¯¬åº¦ */
.log {
  width: 100%;
  max-width: 100%;
}

/* æ‰‹æ©Ÿæ™‚ grid æ”¹æˆ 2 æ¬„ */
@media (max-width: 768px) {
  .grid {
    grid-template-columns: repeat(2, 1fr);
  }

  .topImageGroup {
    right: 10px;
    top: 30px;
  }

  .topImageGroup img {
    height: 60px;
  }
}

/* è¶…å°æ‰‹æ©Ÿæ”¹ 1 æ¬„ */
@media (max-width: 480px) {
  .grid {
    grid-template-columns: 1fr;
  }
  
  .loginRow {
    flex-direction: column;
    align-items: stretch;
  }

  input, button, select {
    width: 100%;
  }

  .searchBox {
    width: 100%;
  }
}

/* header ä¸è¦ç¡¬æ€§æ©«å‘æ’åˆ— */
header {
  flex-wrap: wrap;
}

/* è®“ board ä¸è¢«æ’çˆ† */
#board {
  width: 100%;
  overflow-x: hidden;
}
</style>
</head>

<body>

<!-- =============================
     HTML UI
============================= -->

<h2>âœ… Mold Layout Map</h2>
<div class="topImageGroup">
  <div class="imageRow">
<!-- çœç•¥ -->
<!-- æ­¤è™•ç‚ºbase64åœ–æª” -->

<!-- æ­¤è™•ç‚ºbase64åœ–æª” -->
<!-- çœç•¥ -->
  </div>
  <div class="imageHint">ğŸ‘†ğŸ‘†à¸„à¸¥à¸´à¸à¹€à¸à¸·à¹ˆà¸­à¸‚à¸¢à¸²à¸¢à¸ à¸²à¸_Nháº¥p chuá»™t Ä‘á»ƒ phÃ³ng to hÃ¬nh áº£nh</div>
</div>

  <!-- ç¬¬ä¸€æ’ï¼šä½¿ç”¨è€…ç™»å…¥ -->
  <div class="loginRow">
    <!-- ä½¿ç”¨è€…ç™»å…¥ -->
    <select id="userSelect">
      <option value="">é¸æ“‡äººå“¡_à¹€à¸¥à¸·à¸­à¸à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰_Chá»n ngÆ°á»i dÃ¹ng</option>
      <option value="æ¢ç‰å±±">æ¢ç‰å±±</option>
      <option value="è­šæ–‡ä¸€">è­šæ–‡ä¸€</option>
      <option value="åŠ æœæœ‹">åŠ æœæœ‹</option>
      <option value="é˜¿æœ‹">é˜¿æœ‹</option>
<option value="é˜®æ–‡æ­£">é˜®æ–‡æ­£</option>
<option value="ä½³è¾²">ä½³è¾²</option>
<option value="é˜¿ç©º">é˜¿ç©º</option>
<option value="èŒƒæ–‡æˆ°">èŒƒæ–‡æˆ°</option>
<option value="åº·è¥¿">åº·è¥¿</option>
<option value="é˜®å…‰æˆ°">é˜®å…‰æˆ°</option>
<option value="å¸•æŸ¥å½­">å¸•æŸ¥å½­</option>
<option value="æœæ–‡æ—">æœæ–‡æ—</option>
<option value="é™¶ä¸–ç´€">é™¶ä¸–ç´€</option>
<option value="ç´ç“¦">ç´ç“¦</option>
    </select>
<button id="userLoginBtn" onclick="userLogin()">ğŸ‘¦Login</button>
<button onclick="userLogout()">ğŸšªUser logout</button>
</div>

  <!-- ç¬¬äºŒæ’ï¼šæœå°‹ -->
  <div class="searchRow">
    <div class="searchBox">
  <input id="search" placeholder="æœå°‹æ²»å…·_à¸„à¹‰à¸™à¸«à¸²à¹à¸¡à¹ˆà¸à¸´à¸¡à¸à¹Œ_TÃ¬m kiáº¿m khuÃ´n máº«u (Ex: B8R / B...)" autocomplete="off" />
<div id="dropdown" class="dropdown hidden"></div>
  <button id="dropdownBtn" type="button">â–¼</button>
<button onclick="doSearch()">ğŸ”Search</button>
<button onclick="clearHighlight()">ğŸ§¹Clear</button></div>
  

<div id="board"></div>

<!-- ===== æ‡¸æµ®æŒ‰éˆ• ===== -->
<div id="floatingBtn">â˜°</div>

<div id="floatingMenu" class="floatingMenu hidden">
  <button onclick="scrollTopPage()">â¬† Run to the top</button>
  <button onclick="openRoomSelector()">ğŸ­ choose Robots</button>
  <button onclick="openBoxSelector()">ğŸ“¦ choose Boxes</button>
  <button onclick="scrollBottomPage()">â¬‡ Run to the bottom</button>
</div>

<div class="adminBar">
    <button onclick="adminLogin()" id="adminBtn">ç®¡ç†å“¡ç™»å…¥</button>
    <button onclick="adminLogout()" id="logoutBtn" class="adminOnly">ç®¡ç†å“¡ç™»å‡º</button>
  
 <div class="admin hidden" id="adminPanel">
    <button onclick="addFruit()" class="adminOnly">æ–°å¢æ²»å…·</button>
    <button onclick="removeFruit()" class="adminOnly">åˆªé™¤æ²»å…·</button>
    <button onclick="editNames()">ç·¨è¼¯æ©Ÿå° / å·¥ä½œæ¡Œ / æ²»å…·æ¶åç¨±</button>
    <button onclick="exportLog()">åŒ¯å‡ºæ¬ç§»è¨˜éŒ„ (txt)</button>
<button onclick="exportDropdownKeys()">åŒ¯å‡ºæ²»å…·æ¸…å–® (txt)</button>
<button onclick="exportLayout()">åŒ¯å‡ºæ²»å…·åˆ†å¸ƒä½ç½®</button>
<button onclick="importLayout()">åŒ¯å…¥æ²»å…·åˆ†å¸ƒä½ç½®</button>
</div>
</div>

<!-- æ¬ç§»è¨˜éŒ„æ”¾é€™è£¡ç¿»è­¯ä¸è¦å‹• log -->
<div class="log" id="log" translate="no"></div>

<script>

/* =====================================================
   ç„¡ç¶²è·¯ç›´æ¥é—œé–‰
===================================================== */

function forceClose(message){
    alert(message);
    document.body.innerHTML = "";
    throw new Error("Disconnected");
}

if (!navigator.onLine) {
    forceClose("è£ç½®æœªé€£ç·šï¼Œç³»çµ±é—œé–‰");
}

window.addEventListener("offline", function(){
    forceClose("ç¶²è·¯ä¸­æ–·ï¼Œç³»çµ±é—œé–‰");
});


/* =====================================================
   Firebase åˆå§‹åŒ–
===================================================== */

var firebaseConfig = {
  apiKey: "AIzaSyCIHGQ_R9SOuM3AtENyJpyxzvk_NLVKBWQ",
  authDomain: "mold-map-3c4f3.firebaseapp.com",
  databaseURL: "https://mold-map-3c4f3-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mold-map-3c4f3",
  storageBucket: "mold-map-3c4f3.firebasestorage.app",
  messagingSenderId: "23280455182",
  appId: "1:23280455182:web:65cd7baa4d9e267eaa765f"
};

firebase.initializeApp(firebaseConfig);
var database = firebase.database();



// ================= å…¨åŸŸè®Šæ•¸ =================
let newlyAddedLoc = null;
let selected = null;
let hasMoved = false;
let highlightFruits = [];
let isAdmin = false;
let pendingClear = false;
let currentUser = null;
let lastActivity = Date.now();

/* =====================================================
   å…¨åŸŸè³‡æ–™ï¼ˆå–ä»£ localStorageï¼‰
===================================================== */
let data = {
  rooms: {
    "E266":["(table.1)","(table.2)","(table.3)"],
    "E262":["(table.1)","(table.2)","(table.3)"],
    "E233":["(table.1)","(table.2)","(table.3)"],
    "E202":["(table.1)","(table.2)","(table.3)"],
    "E270":["(table.1)","(table.2)","(table.3)","(table.4)"],
    "E269":["(table.1)","(table.2)","(table.3)","(table.4)"],
    "E232":["(table.1)","(table.2)"],
    "E225":["(table.1)","(table.2)","(table.3)","(table.4)"],
    "E238":["(table.1)","(table.2)","(table.3)","(table.4)"],
    "E243":["(table.1)","(table.2)","(table.3)","(table.4)"],
    "E231":["(table.1)","(table.2)","(table.3)","(table.4)"],
    "E225ä¹‹1":["(table.1)","(table.2)","(table.3)","(table.4)"],
    "E272":["(table.1)","(table.2)","(table.3)"],
    "E234":["(table.1)","(table.2)","(table.3)","(table.4)"],
    "E259":["(table.1)","(table.2)","(table.3)"],
    "E237":["(table.1)","(table.2)","(table.3)","(table.4)"],
    "E273":["(table.1)","(table.2)","(table.3)","(table.4)"],
    "E248":["(table.1)","(table.2)","(table.3)","(table.4)"],
    "E250":["(table.1)","(table.2)","(table.3)","(table.4)"],
    "E260":["(table.1)","(table.2)","(table.3)","(table.4)"],
    "E249":["(table.1)","(table.2)","(table.3)","(table.4)"],
    "E251":["(table.1)","(table.2)","(table.3)","(table.4)"],
    "é ç•™1":["(table.1)","(table.2)","(table.3)","(table.4)"],
    "é ç•™2":["(table.1)","(table.2)","(table.3)","(table.4)"],
    "é ç•™3":["(table.1)","(table.2)","(table.3)","(table.4)"]
  },

  boxes: {
    "Aå€":["A1","A2","A3","A4","A5","A6","A7","A8"],
    "Bå€":["B1","B2","B3","B4","B5","B6","B7","B8","B9","B10","B11","B12","B13","B14"],
    "Cå€":["C1","C2","C3","C4","C5","C6","C7","C8","C9","C10","C11","C12"],
    "Då€":["D1","D2","D3","D4","D5","D6","D7","D8","D9","D10","D11","D12","D13","D14","D15","D16"],
    "Eå€":["E1","E2","E3","E4","E5","E6","E7","E8"],
    "Få€":["F1","F2","F3","F4","F5","F6"],
    "Gå€":["G1","G2","G3","G4","G5","G6"],
    "Hå€":["H1","H2","H3","H4","H5","H6"],
    "Wå€":["W1","W2","W3","W4","W5","W6","W7","W8","W9","W10","W11","W12","W13","W14","W15","W16","W17","W18","W19","W20","W21","W22","W23","W24","W25","W26","W27","W28","W29","W30","W31","W32","W33","W34","W35","W36"],
    "Xå€":["X1","X2","X3","X4","X5","X6","X7","X8","X9","X10","X11","X12","X13","X14","X15","X16","X17","X18","X19","X20","X21","X22","X23","X24","X25","X26","X27","X28","X29","X30"],
    "Yå€":["Y1","Y2","Y3","Y4","Y5","Y6","Y7","Y8",
  "Y9","Y10","Y11","Y12","Y13","Y14","Y15","Y16",
  "Y17","Y18","Y19","Y20","Y21","Y22","Y23","Y24",
  "Y25","Y26","Y27","Y28","Y29","Y30","Y31","Y32",
  "Y33","Y34","Y35","Y36","Y37","Y38","Y39","Y40",
  "Y41","Y42","Y43","Y44","Y45","Y46","Y47","Y48",
  "Y49","Y50","Y51","Y52","Y53","Y54","Y55","Y56",
  "Y57","Y58","Y59","Y60","Y61","Y62","Y63","Y64"],
    "Zé ç•™å€":[
  "Z1","Z2","Z3","Z4","Z5","Z6","Z7","Z8",
  "Z9","Z10","Z11","Z12","Z13","Z14","Z15","Z16",
  "Z17","Z18","Z19","Z20","Z21","Z22","Z23","Z24",
  "Z25","Z26","Z27","Z28","Z29","Z30","Z31","Z32",
  "Z33","Z34","Z35","Z36","Z37","Z38","Z39","Z40",
  "Z41","Z42","Z43","Z44","Z45","Z46","Z47","Z48",
  "Z49","Z50","Z51","Z52","Z53","Z54","Z55","Z56",
  "Z57","Z58","Z59","Z60","Z61","Z62","Z63","Z64"
]
  },

  fruits: [],
  locations: {},
  log: [],
  roomOrder: [],
  boxOrder: []
};

// åˆå§‹åŒ– roomOrder èˆ‡ boxOrder
if (!Array.isArray(data.roomOrder) || !data.roomOrder.length) data.roomOrder = Object.keys(data.rooms);
if (!Array.isArray(data.boxOrder) || !data.boxOrder.length) data.boxOrder = Object.keys(data.boxes);

/* =====================================================
   å¾é›²ç«¯å³æ™‚è¼‰å…¥
===================================================== */

database.ref("systemData").once("value").then(snapshot => {

    if(snapshot.exists()){

        const cloudData = snapshot.val();

        data = {
            ...data,        // ä¿ç•™æœ¬åœ°é è¨­çµæ§‹
            ...cloudData    // ç”¨é›²ç«¯è¦†è“‹å·²æœ‰æ¬„ä½
        };

        render();

    }else{
        save();
    }

});


/* =====================================================
   å„²å­˜åˆ°é›²ç«¯ï¼ˆæ‰€æœ‰æ“ä½œéƒ½ç”¨é€™å€‹ï¼‰
===================================================== */

function save(){
  return database.ref("systemData").set(data)
  .then(()=>{
      console.log("â˜ï¸ åŒæ­¥æˆåŠŸ");
  })
  .catch(err=>{
      console.error(err);
  });
}

/* =====================================================
   Firebase é€£ç·šç›£è½
===================================================== */

let firstConnect = true;

firebase.database().ref(".info/connected")
.on("value", function(snap){
    if(firstConnect){
        firstConnect = false;
        return; // å¿½ç•¥ç¬¬ä¸€æ¬¡
    }

    if(snap.val() === false){
        forceClose("èˆ‡é›²ç«¯å¤±å»é€£ç·š");
    }
});


/* =====================================================
   æ ¸å¿ƒåŠŸèƒ½å€
===================================================== */
// ğŸ“Œ åœ–ç‰‡æ”¾å¤§åŠŸèƒ½ -->
function zoomImage(img) {
  const overlay = document.createElement('div');
  overlay.className = 'imageOverlay';

  const bigImg = document.createElement('img');
  bigImg.src = img.src;

  overlay.appendChild(bigImg);
  document.body.appendChild(overlay);

  overlay.onclick = () => overlay.remove();
}

function exportLog() {
  if (!data.log || !data.log.length) {
    alert('ç›®å‰æ²’æœ‰æ¬ç§»è¨˜éŒ„');
    return;
  }
  const text = data.log.join('\n');  // âœ… ç”¨çœŸæ­£çš„ log
  const blob = new Blob([text], {
    type: 'text/plain;charset=utf-8;'
  });

  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'move_log.txt';

  document.body.appendChild(a); // â­ Safari ä¿éšª
  a.click();
  document.body.removeChild(a);

  URL.revokeObjectURL(a.href);
}

function userLogin() {
  const sel = document.getElementById('userSelect').value;
  if (!sel) {
    alert('à¹‚à¸›à¸£à¸”à¹€à¸¥à¸·à¸­à¸à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰\n' +
  'Vui lÃ²ng chá»n ngÆ°á»i dÃ¹ng\n' +
  'è«‹é¸æ“‡ä½¿ç”¨è€…');
    return;
  }

  currentUser = sel;
  lastActivity = Date.now();
alert(`${currentUser} à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¹à¸¥à¹‰à¸§_ÄÃ£ Ä‘Äƒng nháº­p_å·²ç™»å…¥`);

  // â­ æ”¹ç™»å…¥æŒ‰éˆ•æ–‡å­—
  document.getElementById('userLoginBtn').textContent =
    `ğŸ‘¦Userï¼ˆ${currentUser}ï¼‰`;

  render();
}

function userLogout() {
  if (!currentUser) return;

  alert(`${currentUser} à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸š_ÄÄƒng xuáº¥t_å·²ç™»å‡º`);

  currentUser = null;

  // â­ é‡è¨­äººå“¡é¸å–®å›åˆ°ã€Œé¸æ“‡äººå“¡ã€
  const userSelect = document.getElementById('userSelect');
  userSelect.value = '';

  // â­ é‚„åŸç™»å…¥æŒ‰éˆ•æ–‡å­—
  document.getElementById('userLoginBtn').textContent = 'ğŸ‘¦Login';

  render();
}

function adminLogout() {
  isAdmin = false;
  document.getElementById('adminBtn').textContent = 'ç®¡ç†å“¡ç™»å…¥';
  alert('å·²ç™»å‡ºç®¡ç†å“¡');
  render();
}
document.getElementById('search').addEventListener('keydown', function (e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    doSearch();
  }
});

// å…¨ç«™ç›£è½
function updateActivity() {
  lastActivity = Date.now();
}

// å¸¸è¦‹æ“ä½œéƒ½ç®—
['click', 'mousemove', 'keydown', 'input', 'change'].forEach(evt => {
  document.addEventListener(evt, updateActivity);
});

const AUTO_LOGOUT_MS = 60 * 60 * 1000;

setInterval(() => {
  if (!currentUser && !isAdmin) return;

  if (Date.now() - lastActivity > AUTO_LOGOUT_MS) {
    alert('å·²è¶…é 60 åˆ†é˜æœªæ“ä½œï¼Œè‡ªå‹•ç™»å‡º\n' +
          'à¸£à¸°à¸šà¸šà¸ˆà¸°à¸¥à¹‡à¸­à¸à¹€à¸­à¸²à¸•à¹Œà¹‚à¸”à¸¢à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¹ƒà¸™ 60 à¸™à¸²à¸—à¸µ\n' +
          'Tá»± Ä‘á»™ng Ä‘Äƒng xuáº¥t sau 60 phÃºt');
    userLogout();
    adminLogout();
  }
}, 60 * 1000);

const searchInput = document.getElementById('search');
const dropdown = document.getElementById('dropdown');
const dropdownBtn = document.getElementById('dropdownBtn');

// æ‰“å­— â†’ é¡¯ç¤ºå»ºè­°
searchInput.addEventListener('input', showDropdown);

// é»ç®­é ­ â†’ é–‹é—œåˆ‡æ›
dropdownBtn.addEventListener('click', (e) => {
  e.stopPropagation();   // é˜²æ­¢è§¸ç™¼ document é»æ“Šäº‹ä»¶

  if (dropdown.classList.contains('hidden')) {
// â­ ç§»é™¤æ¸…ç©ºè¡Œç‚º
//searchInput.value = ''; 
    showDropdown();
  } else {
    dropdown.classList.add('hidden');
  }
});

// é»å¤–é¢ â†’ é—œé–‰
document.addEventListener('click', e => {
  if (!e.target.closest('.searchBox')) {
    dropdown.classList.add('hidden');
  }
});

function showDropdown() {
  const key = searchInput.value.trim().toLowerCase();
  dropdown.innerHTML = '';

  const sorted = data.fruits
    .slice()
    .sort((a, b) =>
      a.localeCompare(b, undefined, { sensitivity: 'base' })
    );

  const matches = sorted.filter(f =>
    f.toLowerCase().includes(key)
  );

  if (!matches.length) {
    dropdown.classList.add('hidden');
    return;
  }

  matches.forEach(f => {
    const item = document.createElement('div');
    item.textContent = f;
    item.onclick = () => {
      searchInput.value = f;
      dropdown.classList.add('hidden');
      doSearch();
    };
    dropdown.appendChild(item);
  });

  dropdown.classList.remove('hidden');
}

// ===== æ‡¸æµ®æŒ‰éˆ•æ‹–æ›³ =====
const floatingBtn = document.getElementById('floatingBtn');
const floatingMenu = document.getElementById('floatingMenu');

let isDragging = false;
let offsetX, offsetY;

floatingBtn.addEventListener('mousedown', e => {
  isDragging = true;
  offsetX = e.clientX - floatingBtn.offsetLeft;
  offsetY = e.clientY - floatingBtn.offsetTop;
  floatingBtn.style.cursor = 'grabbing';
});

document.addEventListener('mousemove', e => {
  if (!isDragging) return;
  floatingBtn.style.left = (e.clientX - offsetX) + 'px';
  floatingBtn.style.top = (e.clientY - offsetY) + 'px';
});

document.addEventListener('mouseup', () => {
  isDragging = false;
  floatingBtn.style.cursor = 'grab';
});

// æ‰‹æ©Ÿæ”¯æ´
floatingBtn.addEventListener('touchstart', e => {
  isDragging = true;
  const touch = e.touches[0];
  offsetX = touch.clientX - floatingBtn.offsetLeft;
  offsetY = touch.clientY - floatingBtn.offsetTop;
});

document.addEventListener('touchmove', e => {
  if (!isDragging) return;
  const touch = e.touches[0];
  floatingBtn.style.left = (touch.clientX - offsetX) + 'px';
  floatingBtn.style.top = (touch.clientY - offsetY) + 'px';
});

document.addEventListener('touchend', () => {
  isDragging = false;
});

// ===== é»æ“Šé–‹é—œé¸å–® =====
floatingBtn.addEventListener('click', () => {
  if (isDragging) return;
  floatingMenu.classList.toggle('hidden');
});

// ===== åŠŸèƒ½ =====
function scrollTopPage(){
  window.scrollTo({ top: 0, behavior: 'smooth' });
  floatingMenu.classList.add('hidden');
}

function scrollBottomPage(){
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
  floatingMenu.classList.add('hidden');
}

// ===== å»ºç«‹é¸æ“‡è¦–çª— =====
function createSelector(title, items, prefixText) {

  const overlay = document.createElement('div');
  overlay.style.position = 'fixed';
  overlay.style.inset = '0';
  overlay.style.background = 'rgba(0,0,0,.5)';
  overlay.style.zIndex = '100000';
  overlay.style.display = 'flex';
  overlay.style.alignItems = 'center';
  overlay.style.justifyContent = 'center';

  const box = document.createElement('div');
  box.style.background = 'white';
  box.style.padding = '20px';
  box.style.borderRadius = '10px';
  box.style.maxHeight = '70vh';
  box.style.overflowY = 'auto';
  box.style.minWidth = '250px';

  const h = document.createElement('h3');
  h.textContent = title;
  box.appendChild(h);

  items.forEach(name => {
    const btn = document.createElement('button');
    btn.textContent = name;
    btn.style.display = 'block';
    btn.style.width = '100%';
    btn.style.margin = '5px 0';

    btn.onclick = () => {
      const el = [...document.querySelectorAll('h3')]
        .find(h => h.textContent.includes(prefixText + name));

      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      document.body.removeChild(overlay);
      floatingMenu.classList.add('hidden');
    };

    box.appendChild(btn);
  });

  overlay.appendChild(box);
  overlay.onclick = (e)=>{
    if(e.target===overlay) document.body.removeChild(overlay);
  };

  document.body.appendChild(overlay);
}

// ===== Robots é¸å–® =====
function openRoomSelector(){
  createSelector("é¸å– Robots", data.roomOrder, "æ©Ÿå° ");
}

// ===== Boxes é¸å–® =====
function openBoxSelector(){
  createSelector("é¸å– Boxes", data.boxOrder, "æ²»å…·æ¶ ");
}

/* Console=btoa('abc789') */
/* ====== ç®¡ç†å“¡ç™»å…¥ ===== */
const ADMIN_HASH = 'MDQyNA=='; 

function adminLogin() {
  const p = prompt('è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼');
  if (!p) return;

  if (btoa(p) === ADMIN_HASH) {
    isAdmin = true;
    lastActivity = Date.now();
    document.getElementById('adminBtn').textContent = 'ç®¡ç†å“¡å·²ç™»å…¥';
    render();
  } else {
    alert('å¯†ç¢¼éŒ¯èª¤');
  }
}

/* ====== æœå°‹ ====== */
function doSearch() {
  if (!requireLogin()) return;

  const key = document.getElementById('search').value.trim().toLowerCase();
  highlightFruits = [];
  let hitLocs = [];

  if (!key) {
    render();
    return;
  }

  const exact = [];
  const fuzzy = [];

  Object.entries(data.locations).forEach(([loc, fruit]) => {
    if (!fruit) return;
    const f = fruit.toLowerCase();
    if (f === key) exact.push({ loc, fruit });
    else if (f.includes(key)) fuzzy.push({ loc, fruit });
  });

  const hits = exact.length ? exact : fuzzy;
  highlightFruits = hits.map(h => h.fruit);
  hitLocs = hits.map(h => h.loc);

render();

if (hitLocs.length) {
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {

      const el = document.getElementById(`cell-${hitLocs[0]}`);
      if (!el) return;

      const rect = el.getBoundingClientRect();
      const y = rect.top + window.scrollY;

      window.scrollTo({
        top: y - window.innerHeight / 2 + rect.height / 2,
        behavior: 'smooth'
      });

    });
  });
} else {
    alert('æŸ¥ç„¡æ²»å…·');
  }
  // â­â­ çµ±ä¸€åœ¨æœ€å¾Œé—œé–‰ä¸‹æ‹‰é¸å–®ï¼ˆæœ€ä¹¾æ·¨ï¼‰
  document.getElementById('dropdown').classList.add('hidden');
}

/* ====== æ¸…é™¤æœå°‹ ====== */
function clearHighlight() {
  highlightFruits = [];
  document.getElementById('search').value = '';
// ğŸ”½ é—œé–‰ç®­é ­å±•é–‹
  document.getElementById('dropdown').classList.add('hidden');
  render();
}

/* ====== æ–°å¢æ²»å…· ====== */ 
function addFruit() {
 if (!isAdmin) return alert('è«‹å…ˆç™»å…¥ç®¡ç†å“¡');
 safeInit();
 const n = prompt('æ–°å¢æ²»å…·åç¨±');
 if (!n) return;
 if (data.fruits.includes(n)) return alert('åç¨±å·²å­˜åœ¨');

 const emptyKey = Object.keys(data.locations).find(
 k => data.locations[k] === null
 );
 if (!emptyKey) return alert('ç›®å‰æ²’æœ‰ç©ºä½');

 data.fruits.push(n);
 data.locations[emptyKey] = n;

 newlyAddedLoc = emptyKey;
 selected = emptyKey;
 save(); render(); document.getElementById(`cell-${emptyKey}`)
 ?.scrollIntoView({ behavior: 'smooth', block: 'center'
 });
 setTimeout(() => {
 newlyAddedLoc = null;
 render();
 }, 5000);
 }

/* ====== åˆªé™¤æ²»å…· ====== */
function removeFruit() {
  if (!isAdmin) return alert('è«‹å…ˆç™»å…¥ç®¡ç†å“¡');

  if (selected) {
    const n = data.locations[selected];
    if (!n) return;

    if (!confirm(`ç¢ºå®šåˆªé™¤æ²»å…·ã€Œ${n}ã€ï¼Ÿ`)) return;

    data.fruits = data.fruits.filter(f => f !== n);
    Object.keys(data.locations).forEach(k => {
      if (data.locations[k] === n) data.locations[k] = null;
    });

    selected = null;
    save();
    render();
    return;
  }

  const n = prompt('åˆªé™¤æ²»å…·åç¨±');
  if (!data.fruits.includes(n)) return;

  data.fruits = data.fruits.filter(f => f !== n);
  Object.keys(data.locations).forEach(k => {
    if (data.locations[k] === n) data.locations[k] = null;
  });

  save();
  safeInit();
render();
}

/* ====== åŒ¯å‡ºæ²»å…·åˆ†å¸ƒä½ç½® ====== */
function exportLayout() {
  if (!isAdmin) return alert('è«‹å…ˆç™»å…¥ç®¡ç†å“¡');

  const layout = {};

  Object.entries(data.locations).forEach(([loc, fruit]) => {
    if (fruit) layout[loc] = fruit;
  });

  const blob = new Blob(
    [JSON.stringify(layout, null, 2)],
    { type: 'application/json;charset=utf-8;' }
  );

  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'tool_layout.json';

  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
}

/* ====== åŒ¯å…¥æ²»å…·åˆ†å¸ƒä½ç½® ====== */
function importLayout() {
  if (!isAdmin) return alert('è«‹å…ˆç™»å…¥ç®¡ç†å“¡');

  reader.onload = e => {
  let imported;

  try {
    imported = JSON.parse(e.target.result);
  } catch (err) {
    alert('JSON è§£æå¤±æ•—: ' + err.message);
    return;
  }

  if (!confirm('åŒ¯å…¥æœƒè¦†è“‹ç›®å‰æ‰€æœ‰æ²»å…·ä½ç½®ï¼Œç¢ºå®šç¹¼çºŒï¼Ÿ')) return;

  try {

    safeInit();

    Object.keys(data.locations).forEach(k => data.locations[k] = null);
    data.fruits = [];

    Object.entries(imported).forEach(([loc, fruit]) => {
      data.locations[loc] = fruit;

      if (!data.fruits.includes(fruit)) {
        data.fruits.push(fruit);
      }
    });

    data.log.unshift(
      `${new Date().toLocaleString()} | åŒ¯å…¥æ²»å…·åˆ†å¸ƒä½ç½® | æ“ä½œè€…: ${currentUser || 'ç®¡ç†å“¡'}`
    );

    save()
      .then(() => {
        render();
        alert('â˜ï¸ åŒ¯å…¥å®Œæˆï¼Œå·²åŒæ­¥è‡³é›²ç«¯');
      })
      .catch(err => {
        alert('âŒ é›²ç«¯åŒæ­¥å¤±æ•—: ' + err.message);
      });

  } catch (err) {
    console.error(err);
    alert('åŒ¯å…¥æµç¨‹éŒ¯èª¤: ' + err.message);
  }
};

/* ====== åŒ¯å‡º dropdown æ²»å…· KEY ====== */
function exportDropdownKeys() {
  if (!isAdmin) return alert('è«‹å…ˆç™»å…¥ç®¡ç†å“¡');

  if (!data.fruits || data.fruits.length === 0) {
    return alert('ç›®å‰æ²’æœ‰æ²»å…·å¯åŒ¯å‡º');
  }

  const content = data.fruits.join('\n'); // ä¸€è¡Œä¸€å€‹
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8;' });

  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'fixtures.txt';
  a.click();

  data.log.unshift(
    `${new Date().toLocaleString()} | åŒ¯å‡ºæ²»å…·æ¸…å–®(txt) | æ“ä½œè€…: ç®¡ç†å“¡`
  );

  save();
}

function cell(locKey, displayName) {
  const d = document.createElement('div');
  const f = data.locations[locKey];
  d.className = 'cell';
  d.id = `cell-${locKey}`;
  if (!f) d.classList.add('empty');
  if (highlightFruits.includes(f)) d.classList.add('highlight');
  if (selected===locKey) d.classList.add('selected');
  if (locKey===newlyAddedLoc) d.classList.add('new-added');
  d.textContent = `${displayName}: ${f || '(null)'}`;
  d.onclick = ()=>select(locKey);
  return d;
}

// ================= æ“ä½œ =================
function requireLogin(){
  if(isAdmin){ lastActivity=Date.now(); return true; }
  if(!currentUser){ alert('à¹‚à¸›à¸£à¸”à¹€à¸¥à¸·à¸­à¸à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰\n' +
  'Vui lÃ²ng chá»n ngÆ°á»i dÃ¹ng\n' +
  'è«‹é¸æ“‡ä½¿ç”¨è€…'); return false; }
  lastActivity=Date.now();
  return true;
}

function select(loc){
  if(!requireLogin()) return;
  const fruit = data.locations[loc];
  if(selected===loc){ selected=null; hasMoved=false; render(); return; }
  if(!selected){ selected=loc; hasMoved=false; render(); return; }
  if(hasMoved){ selected=null; hasMoved=false; render(); return; }

  if(selected!==loc){
    const a=data.locations[selected], b=data.locations[loc];
    if(a) removeDuplicateFruit(a, loc);
    if(b) removeDuplicateFruit(b, selected);
    data.locations[selected]=b;
    data.locations[loc]=a;
    const operator = isAdmin ? 'ç®¡ç†å“¡' : currentUser;
    data.log.unshift(`${new Date().toLocaleString()} | ${selected} â†’ ${loc} | ${a||'ç„¡æ²»å…·'} | æ“ä½œè€…: ${operator}`);
    save();
    selected = loc;
    hasMoved = true;
    pendingClear = true;
    render();
  }
}

function removeDuplicateFruit(fruit, exceptLoc=null){
  for(const loc in data.locations) if(loc!==exceptLoc && data.locations[loc]===fruit) data.locations[loc]=null;
}

// ================= æ–°å¢ç®¡ç†å“¡æ”¹ååŠŸèƒ½ =================
function editNames(){
  if(!isAdmin) return alert('è«‹å…ˆç™»å…¥ç®¡ç†å“¡');
  const choice = prompt('æ”¹åé¸æ“‡:\n1- Room\n2- Table\n3- Box\n4- Boxå…§å°æ¡†');
  if(!choice) return;
  if(choice==='1'){ // Room
    const oldName = prompt('è¼¸å…¥åŸ Room åç¨±'); if(!oldName||!data.rooms[oldName]) return alert('ä¸å­˜åœ¨');
    const newName = prompt('è¼¸å…¥æ–° Room åç¨±'); if(!newName) return;
    if(data.rooms[newName]) return alert('åç¨±å·²å­˜åœ¨');
    data.rooms[newName]=data.rooms[oldName]; delete data.rooms[oldName];
    const idx = data.roomOrder.indexOf(oldName); if(idx>=0) data.roomOrder[idx]=newName;
    Object.keys(data.locations).forEach(k=>{
      if(k.startsWith(oldName+'|')){
        const t = k.split('|')[1];
        data.locations[`${newName}|${t}`]=data.locations[k];
        delete data.locations[k];
      }
    });
    data.log.unshift(`${new Date().toLocaleString()} | Room ${oldName} â†’ ${newName} | æ“ä½œè€…: ç®¡ç†å“¡`);
    save(); render(); alert('Room åç¨±å·²ä¿®æ”¹'); return;
  }
  if(choice==='2'){ // Table
    const roomName = prompt('è¼¸å…¥ Table æ‰€åœ¨ Room åç¨±'); if(!roomName||!data.rooms[roomName]) return alert('Room ä¸å­˜åœ¨');
    const oldTable = prompt('è¼¸å…¥åŸ Table åç¨±'); if(!oldTable||!data.rooms[roomName].includes(oldTable)) return alert('Table ä¸å­˜åœ¨');
    const newTable = prompt('è¼¸å…¥æ–° Table åç¨±'); if(!newTable) return;
    const idx = data.rooms[roomName].indexOf(oldTable); data.rooms[roomName][idx]=newTable;
    const oldKey = `${roomName}|${oldTable}`;
    const newKey = `${roomName}|${newTable}`;
    data.locations[newKey]=data.locations[oldKey]; delete data.locations[oldKey];
    data.log.unshift(`${new Date().toLocaleString()} | Table ${oldKey} â†’ ${newKey} | æ“ä½œè€…: ç®¡ç†å“¡`);
    save(); render(); alert('Table åç¨±å·²ä¿®æ”¹'); return;
  }
  if(choice==='3'){ // Box
    const oldBox = prompt('è¼¸å…¥åŸ Box åç¨±'); if(!oldBox||!data.boxes[oldBox]) return alert('Box ä¸å­˜åœ¨');
    const newBox = prompt('è¼¸å…¥æ–° Box åç¨±'); if(!newBox) return;
    data.boxes[newBox]=data.boxes[oldBox]; delete data.boxes[oldBox];
    const idx = data.boxOrder.indexOf(oldBox); if(idx>=0) data.boxOrder[idx]=newBox;
    Object.keys(data.locations).forEach(k=>{
      if(k===oldBox){ data.locations[newBox]=data.locations[oldBox]; delete data.locations[oldBox]; }
    });
    data.log.unshift(`${new Date().toLocaleString()} | Box ${oldBox} â†’ ${newBox} | æ“ä½œè€…: ç®¡ç†å“¡`);
    save(); render(); alert('Box åç¨±å·²ä¿®æ”¹'); return;
  }
  if(choice==='4'){ // Box å°æ¡†
    const boxName = prompt('è¼¸å…¥æ‰€åœ¨ Box åç¨±'); if(!boxName||!data.boxes[boxName]) return alert('Box ä¸å­˜åœ¨');
    const oldCell = prompt('è¼¸å…¥åŸå°æ¡†åç¨±'); if(!oldCell||!data.boxes[boxName].includes(oldCell)) return alert('å°æ¡†ä¸å­˜åœ¨');
    const newCell = prompt('è¼¸å…¥æ–°å°æ¡†åç¨±'); if(!newCell) return;
    const idx = data.boxes[boxName].indexOf(oldCell); data.boxes[boxName][idx]=newCell;
    if(data.locations[oldCell]!==undefined){ data.locations[newCell]=data.locations[oldCell]; delete data.locations[oldCell]; }
    data.log.unshift(`${new Date().toLocaleString()} | Boxå…§å°æ¡† ${oldCell} â†’ ${newCell} | æ“ä½œè€…: ç®¡ç†å“¡`);
    save(); render(); alert('å°æ¡†åç¨±å·²ä¿®æ”¹'); return;
  }
}

/* ====== çµæ§‹åŒæ­¥å™¨ ====== */
function safeInit(){

  // ========= åŸºæœ¬æ¬„ä½ä¿è­· =========
  if(!data.rooms) data.rooms = {};
  if(!data.boxes) data.boxes = {};
  if(!data.fruits) data.fruits = [];
  if(!data.locations) data.locations = {};
  if(!data.log) data.log = [];
  if(!data.roomOrder) data.roomOrder = Object.keys(data.rooms);
  if(!data.boxOrder) data.boxOrder = Object.keys(data.boxes);

  // ========= è£œé½Šæ‰€æœ‰ Room Table =========
  for(const room in data.rooms){
    data.rooms[room].forEach(table=>{
      const key = `${room}|${table}`;
      if(!(key in data.locations)){
        data.locations[key] = null;
      }
    });
  }

  // ========= è£œé½Šæ‰€æœ‰ Box å°æ¡† =========
  Object.values(data.boxes).flat().forEach(boxCell=>{
    if(!(boxCell in data.locations)){
      data.locations[boxCell] = null;
    }
  });

  // ========= æ¸…ç†å­¤å…’ key =========
  for(const loc in data.locations){

    const isTable = loc.includes('|');

    if(isTable){
      const [room, table] = loc.split('|');
      if(!data.rooms[room] || !data.rooms[room].includes(table)){
        delete data.locations[loc];
      }
    }else{
      const allBoxCells = Object.values(data.boxes).flat();
      if(!allBoxCells.includes(loc)){
        delete data.locations[loc];
      }
    }
  }

}

// ================= æ¸²æŸ“ =================
function render() {
  const board = document.getElementById('board');
  board.innerHTML = '';

  // ç•« room
  data.roomOrder.forEach(r => {
    if(!data.rooms[r]) return;
    const div = document.createElement('div');
    div.className = 'room';
    div.innerHTML = `<h3>æ©Ÿå° ${r}</h3><div class="grid"></div>`;
    const grid = div.querySelector('.grid');

    data.rooms[r].forEach(t => {
      const key = `${r}|${t}`;
      grid.appendChild(cell(key, t));
    });

    board.appendChild(div);
  });

  // ç•« boxes
  data.boxOrder.forEach(group => {
    if(!data.boxes[group]) return;
    const div = document.createElement('div');
    div.className = `boxes ${group}`;
    div.innerHTML = `<h3>æ²»å…·æ¶ ${group}</h3><div class="grid"></div>`;
    const grid = div.querySelector('.grid');

    data.boxes[group].forEach(b => {
      grid.appendChild(cell(b, b));
    });

    board.appendChild(div);
  });

  document.getElementById('log').textContent = data.log.join('\n');
  document.querySelectorAll('.adminOnly')
    .forEach(b=>b.style.display=isAdmin?'':'none');

  document.getElementById('adminPanel')
    .classList.toggle('hidden', !isAdmin);
}

function writeLog(text){
    data.log.push(text);
    const logDiv = document.getElementById("log");
    if(logDiv){
        logDiv.textContent = data.log.join("\n");
        logDiv.scrollTop = logDiv.scrollHeight;
    }
}

/* ====== é¿å…æ¼æ‰ save()ï¼Œçµ±ä¸€å…¥å£ ====== */
function updateData(callback){

  callback();   // ä¿®æ”¹ data
  save();
  render();

}




</script>
</body>
</html>


